name: Status Sync

on:
  issues:
    types: [opened, edited, labeled, unlabeled, closed, reopened]
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: read
  pull-requests: write

concurrency:
  group: status-sync
  cancel-in-progress: true

jobs:
  sync-status:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate status content
        id: generate
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Fetch all open issues
            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            // Fetch recently closed issues (last 14 days)
            const twoWeeksAgo = new Date();
            twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
            const { data: closedIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              since: twoWeeksAgo.toISOString(),
              per_page: 100
            });
            
            // Helper to format issue list
            const formatIssueList = (issues) => {
              if (issues.length === 0) return 'No issues.';
              return issues.map(i => `- [#${i.number}](${i.html_url}) ${i.title}`).join('\n');
            };
            
            // Filter issues by label
            const inProgress = openIssues.filter(i => i.labels.some(l => l.name === 'in-progress'));
            const p0Issues = openIssues.filter(i => i.labels.some(l => l.name === 'P0'));
            const p1Issues = openIssues.filter(i => i.labels.some(l => l.name === 'P1'));
            const p2Issues = openIssues.filter(i => i.labels.some(l => l.name === 'P2'));
            
            // Read current STATUS.md
            let statusContent = fs.readFileSync('STATUS.md', 'utf8');
            
            // Extract manual notes section (everything after AUTOMATION_END)
            const automationEndMarker = '<!-- AUTOMATION_END -->';
            const manualStartIndex = statusContent.indexOf(automationEndMarker);
            const manualNotes = manualStartIndex >= 0 
              ? statusContent.substring(manualStartIndex + automationEndMarker.length)
              : '\n\n---\n\n## Manual Notes & Context\n\n_Add notes here._\n';
            
            // Build new automated section
            const timestamp = new Date().toISOString().split('T')[0];
            const automatedSection = `# Project Status

**Last updated:** ${timestamp}  
**See also:** [README.md](README.md) • [AGENTS.md](AGENTS.md) • [docs/](docs/README.md)

This file is the **Single Source of Truth** for project status. AI agents and automation should read this first to understand current priorities and active work.

---

<!-- AUTOMATION_START -->
## Now (In Progress)

_This section is auto-generated by automation. Issues with label \`in-progress\`._

<!-- in-progress-list -->
${formatIssueList(inProgress)}
<!-- /in-progress-list -->

---

## Next (Prioritized Backlog)

_This section is auto-generated by automation. Issues grouped by priority labels P0/P1/P2._

### P0 (Critical)
<!-- p0-list -->
${formatIssueList(p0Issues)}
<!-- /p0-list -->

### P1 (High Priority)
<!-- p1-list -->
${formatIssueList(p1Issues)}
<!-- /p1-list -->

### P2 (Medium Priority)
<!-- p2-list -->
${formatIssueList(p2Issues)}
<!-- /p2-list -->

---

## Recently Closed (Last 14 Days)

_This section is auto-generated by automation._

<!-- recently-closed-list -->
${formatIssueList(closedIssues)}
<!-- /recently-closed-list -->

<!-- AUTOMATION_END -->`;

            // Combine with manual notes
            const newContent = automatedSection + manualNotes;
            
            // Write new content
            fs.writeFileSync('STATUS.md', newContent, 'utf8');
            
            console.log('STATUS.md updated successfully');
            return 'success';

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update STATUS.md (automated)'
          title: 'chore: update STATUS.md (automated)'
          body: |
            This is an automated update of STATUS.md based on current issue labels.
            
            - In Progress: issues with `in-progress` label
            - Next P0/P1/P2: issues with priority labels
            - Recently Closed: issues closed in the last 14 days
            
            **Manual notes section is preserved.**
          branch: automation/status-sync
          delete-branch: true
          labels: automation
